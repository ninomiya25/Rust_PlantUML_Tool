# 社内向けセキュアなPlantUMLウェブエディタ

## [Intent/背景]

### 目的:なぜ作るのか

* 全社員(設計者、特に手元に開発環境を用意していないユーザー)を対象に
PlantUMLを用いて手軽にUML図を作成できる環境を用意する。

### 解決するユーザー

全社員(設計者、特に手元に開発環境を用意していないユーザー)

### ビジネス課題

**背景**

- AIの利用や構成管理といった観点から、従来の非定型データ形式(Excel,Word,PowerPoint)から構造化されたドキュメント文書(Semantic Documents )に移行する取り組みを進行している。
- ドキュメント内でUMLを表記するにはPlantuMLと呼ばれるテキストベースの表記方法が有効であり、Semantic DocumentsにおいてもPlantuMLの使用が推奨されている。

**課題**

1. PlantUMLの利用にはjavaやgraphviz、vscodeなどのツールのインストールが必要であり、環境構築に手間がかかる。
2. 簡単にPlantUMLを利用できる環境としてPlantUMLの公式サイトが存在するが、外部サイトであるためセキュリティの観点から設計時の使用は推奨されない。

## [Scop/NonGoals]

### 対象範囲

1. PlantUMLを用いたUMLの描画(25年度)
2. AIを用いたPlantUMLコード作成補助(26年度)　今回はやらない
3. (説明/補助)PlantUMLコードのテンプレートやUMLの説明の記載ページ(26年度)今回はやらない

#### 最優先1:PlantUMLを用いたUMLの描画

### やること

* UMLの描画:PlantUMLの編集後に逐次反映するリアルタイムプレビュー
* 画像(PNG,SVG)のエクスポート
* PlantUMLコードをブラウザ上で一時保存し、再読み込みできる機能(最大10まで)
* 構文エラーとシステムエラーの指摘
* ログ出力
* ブラウザを離れても編集中のテキストが保持される
* 複数タブで同じエディタを開いても許容する
* Chrome, Edge, Firefoxで対応する　(画面項目、セキュリティ面の違いがある)

### やらないこと

* オフラインでの対応はしない
* ユーザー認証はしない
* データベースは使用しない
* テキストファイルのアップロード・読み込みは対応しない(手動コピペで対応)
* PlantUMLテキストのtxt,puml形式の保存は対応しない(手動コピペで対応)

## [振る舞い仕様]

## ユーザーストーリーと完了の定義

### ユーザーストーリー 1 - PlantUMLテキストからリアルタイム図生成 (優先度: P1)

設計者はブラウザ上でPlantUMLテキストを入力し、即座に図が表示されることで、環境構築なしにUML図を作成できる。

**この優先度の理由**: 本機能の中核であり、ユーザーが最も必要としている基本的な価値。これだけで実用可能なMVPとなる。

**独立テスト**: ブラウザでエディタを開き、サンプルのPlantUMLテキストを入力して図が表示されることで完全にテストできる。

**受入シナリオ**:

1. **Given** ユーザーがウェブエディタにアクセスした, **When** PlantUMLテキスト (例: `@startuml\nAlice -> Bob: Hello\n@enduml`) を入力する, **Then** 対応するシーケンス図がリアルタイムで表示される
2. **Given** ウェブエディタに図が表示されている, **When** テキストを編集する, **Then** 図が自動的に更新される
3. **Given** ユーザーが無効なPlantUML構文を入力した, **When** 変換が実行される, **Then** 構文エラーが画像で表示される

---

### ユーザーストーリー 2 - 図のエクスポート機能 (優先度: P2)

設計者は作成した図を画像ファイル(PNG/SVG)としてダウンロードできる。

**この優先度の理由**: 図を作成しても出力できなければ実用性が低い。ただし、プレビューだけでも価値はあるためP2。

**独立テスト**: PlantUML図を表示後、エクスポートボタンをクリックして画像ファイルがダウンロードされることで検証できる。

**受入シナリオ**:

1. **Given** ユーザーが図を表示している, **When** "PNG形式でエクスポート"ボタンをクリックする, **Then** PNG画像ファイルがダウンロードされる
2. **Given** ユーザーが図を表示している, **When** "SVG形式でエクスポート"ボタンをクリックする, **Then** SVG画像ファイルがダウンロードされる

---

### ユーザーストーリー 3 - ブラウザ上での一時保存・再読込 (優先度: P3)

設計者は作成中のPlantUMLテキストをブラウザ上に一時保存（最大10）し、後で再読込することで編集を再開できる。

**この優先度の理由**: 複数の図を比較・切り替えながら作業する際の利便性を高める。ただし、基本機能だけでも価値があるためP3。

**独立テスト**: テキストを入力後、"一時保存"ボタンをクリックすることで左側タブの保存一覧のスロットに追加され、一時保存される。保存一覧から対象のスロットを選択することで復元される。

**受入シナリオ**:

1. **Given** ユーザーがPlantUMLテキストを入力している, **When** "一時保存"ボタンをクリックする, **Then** 現在のエディタのテキストがスロット1に保存される
2. **Given** ユーザーが既に1つスロット1に保存している, **When** 別のテキストを入力して"一時保存"をクリックする, **Then** 現在のエディタのテキストがスロット2に保存される
3. **Given** ユーザーが2つのテキストを保存している, **When** 左側タブの保存一覧から"スロット1"をクリックする, **Then** スロット1のテキストがエディタに読み込まれる
4. **Given** ユーザーがブラウザを閉じた, **When** 再度エディタにアクセスする, **Then** 保存したテキスト（最大10）が保持されている

---

### ユースケース

````plantuml
@startuml
left to right direction
skinparam packageStyle rectangle

actor 設計者 as Designer

package "PlantUMLリアルタイム図作成システム" {

  usecase "FR-001\nPlantUMLテキスト編集" as UC_Edit
  usecase "FR-002\nPlantUML図生成" as UC_Generate
  usecase "FR-005\nPNG形式でエクスポート" as UC_ExportPNG
  usecase "FR-007\nPlantUMLテキスト一時保存/再読込\n（最大2つ）" as UC_SaveLoad

}

Designer --> UC_Edit : テキスト入力
UC_Edit --> UC_Generate : 入力テキスト送信・図生成要求
UC_Generate --> UC_Edit : 図の表示/エラー通知

Designer --> UC_ExportPNG : 図のPNG/SVGエクスポート
Designer --> UC_SaveLoad : PlantUMLテキストの一時保存・再読込

@enduml
````

### 画面遷移

* 今回の対象範囲ではホーム画面(メイン画面)のみ

### 状態遷移表

 | イベント | 遷移前状態 | 遷移後状態 |
|:------|:------:|------:|
| テキストエディタの編集完了から1秒経過|エディタ上にテキストが入力されている|PMG形式で画像をホーム画面に表示する|
|一時保存|エディタ上にテキストが入力されている|空いているスロットにエディタ上のテキストデータを保存する&エディタはクリアになる|
|再読み込み(スロットの選択)|----|エディタ上に保存されたテキストデータを展開する|
|PNG形式でのエクスポート|エディタ上にテキストが入力されている|エディタ上に入力されているテキストデータを送信し、PNG形式で画像がダウンロードされる|
|SVG形式でのエクスポート|エディタ上にテキストが入力されている|エディタ上に入力されているテキストデータを送信し、SVG形式で画像がダウンロードされる|

### データフロー

1. **入力**: ユーザーがブラウザ上でPlantUMLテキストを入力
2. **送信**: フロントエンドがバックエンドAPIにテキストを送信
3. **処理**: バックエンドのPlantUMLサーバーが図を生成
4. **出力**: PNG/SVG形式の画像データをフロントエンドに返却
5. **表示**: ブラウザ上でプレビュー表示

[インターフェース/データ契約]

### PlantUML変換機能の入出力

* PlantUMLが変換に対応している拡張子
  * {txt, tex, java, htm, html, c, h, cpp, apt, pu, puml, hpp, hh, md}
* 出力形式
  * {PNG,SVG}(構文エラー時も画像を出力)
* 参考: 実行コマンド例: java -jar plantuml-1.2025.10.jar ./sequenceDiagram.txt

### 入力データ仕様

**形式**: テキストデータ (UTF-8エンコーディング)

**必須要件**:

* テキスト形式であること
  * 異なる場合はシステムエラーメッセージを返す
* 入力があること、または空白文字のみでないこと
  * 入力がない、空白文字しかない場合は変換処理をしない
* `@startuml` タグで開始し、 `@enduml` タグで終了すること
  * 異なる場合は、構文エラーを画像で返す

### 出力データ仕様

**正常時の出力1**: PNG形式のバイナリデータ (表示/エクスポート)

**必須要件**:

* PNG形式のバイナリデータであること
  * 有効なPNGヘッダーを持つこと（`89 50 4E 47`で始まる）
* 画像データが空でないこと（画像サイズ > 0バイト）
* 画像サイズの最大の大きさは `8192 x 8192` とする
* PlantUMLテキストに構文エラーがあっても画像を返却すること
  * PlantUMLが検出した内容をPNG画像で返す

**正常時の出力2**: SVG形式のバイナリデータ (エクスポートのみ)

**必須要件**:

* SVG形式のバイナリデータであること
* 画像データが空でないこと（画像サイズ > 0バイト）
* 画像サイズの最大の大きさは `8192 x 8192` とする
* PlantUMLテキストに構文エラーがあっても画像を返却すること

**エラー時の出力**:　テキストデータ

**必須要件**:

* システムエラー
  * バックエンドサーバーの障害
  * PlantUMLサーバープロセスのクラッシュ
  * HTTPステータス: `500 Internal Server Error`
  * レスポンスボディ:テキストデータ `{"error": "システムエラーが発生しました"}`
  * ログ出力：{(ログレベル) (時間) (アクセス対象)（処理内容）（処理結果）（メッセージ）}

* ネットワークエラー
  * タイムアウト（30秒以上応答なし）
  * 接続エラー
  * HTTPステータス: `504 Gateway Timeout` または `503 Service Unavailable`
  * レスポンスボディ: テキストデータ `{ "error": "ネットワークエラーが発生しました"}`
  * ログ出力:{(ログレベル) (時間) (アクセス対象)（処理内容）（処理結果）（メッセージ）}

### エッジケース(境界)

- **PlantUMLファイル**: `100`行以下のPlantUMLテキストを入力した場合、バックエンドは`90パーセンタイル`で`400`ミリ秒以内で処理をし、レスポンス返す
  - 参考:ドハティの閾値
- **大規模なPlantUMLファイルの上限** ：入力文字数上限は設けないが、`3000`行までを動作対応の目安とする。
  - ※参考:PlantUML公式で入力文字数上限の明記はない。
  - 公式サーバーで確認した大まかな目安:1000-3000行：描画可能, 4000-6000行:描画できるが挙動が安定しない,　8000行以上:描画できない
- **生成される画像サイズの上限**: PlantUMLは画像の幅と高さを通常`4096`に制限されている。環境変数`PLANTUML_LIMIT_SIZE`やコマンドラインの引数で拡張した場合は`8192`
  - 非常に大きな（例えば、 `20 000 x 10 000` ピクセルを超えるような）図を作成しようとした場合、メモリ問題が発生するため最大サイズは `8192 x 8192` とする
  - ※参考:出力する画像サイズはPlantUMLコードの構文`scale XX`でXX倍に縮小拡大可能
- **無効な構文**: 文法エラーのあるPlantUMLを入力した場合、構文エラーを画像で表示する
- **ブラウザ互換性**: Chrome, Edge, Firefoxで動作する
- **バックエンドサーバー障害**: PlantUMLサーバーがダウンしている場合、ユーザーにシステムエラーメッセージを表示する
- **ネットワーク遅延**: ネットワークが遅い環境でタイムアウトした場合は、ユーザーにネットワークエラーメッセージを表示する
- **一時保存の上限**: 既に保存上限(10つ一時保存されている)状態で一時保存しようとしたとき、保存がキャンセルされ、警告が表示される
- **セッションの永続性**: ブラウザをリフレッシュしてもローカルストレージで一時保存されたテキストは保持される
- **複数タブでの一時保存**: ローカルストレージを利用し、複数タブで一時保存を実行した場合であっても保存内容は共有される
- **同時編集**: エディタの編集内容はタブごとに独立し、複数タブで同じエディタを開いた場合、編集内容は共有されない
- **LocalStorageの容量制限**: LocalStorageの容量制限は`5MB` 大きなPlantUMLテキストを保存した場合であっても、1つのスロット辺りおおよそ15万文字まで許容できるため考慮しなくてよい
  - ※参考:UTF-8でのバイト数:半角英数字や記号は1バイト、ひらがな・カタカナ・漢字は通常3バイト
- **他のエディタとの併用**　Linux, macOSの環境のエディタから本システムへテキストをコピペしたとき、改行コードなどの問題で図を正しく反映できない場合が考えられる。現時点の対象法としては改行を`\n`に手動で置き換えること(調査中)

## [技術・品質要件]

### 機能要件

- **FR-001**: システムはブラウザ上でPlantUMLテキストを編集できるテキストエディタを提供しなければならない
- **FR-002**: システムは入力されたPlantUMLテキストをバックエンドのPlantUMLサーバーに送信し、テキストから画像への変換処理を実行しなければならない
- **FR-003**: システムはテキストエディタのPlantUMLテキストに変更があれば、即座に図に反映するリアルタイムプレビューを提供しなければならない
  - システムはテキストエディタにおいてテキストの入力・更新が完了した`1`秒後に、PlantUMLテキストをバックエンドに送信する
  - 1秒間隔でテキストが編集され、リクエストが複数回送られた場合は、最後に送られたリクエストのみを対応する
- **FR-004**: システムはPlantUML構文エラーを検出し、表示しなければならない
- **FR-005**: システムは生成された図をPNG形式でエクスポートする機能を提供しなければならない
- **FR-006**: システムは生成された図をSVG形式でエクスポートする機能を提供しなければならない
- **FR-007**: システムはPlantUMLテキストを最大2つまでブラウザのローカルストレージに一時保存する機能を提供しなければならない
- **FR-008**: システムは一時保存したPlantUMLテキストを再読込する機能（スロット1、スロット2……スロット10）を提供しなければならない
- **FR-009**: システムはブラウザをリフレッシュしても一時保存したテキストを保持しなければならない
- **FR-010**: システムはシステムエラーがあった場合、エラー内容に沿ってログを出力しなければならない

### 非機能要件

- **NFR-001**: バックエンドのPlantUMLサーバーは`100`行のPlantUMLソースを`90パーセンタイル`で`400`ミリ秒以内で処理しなければならない
- **NFR-002**: フロントエンドはChrome、Edge、Firefoxの最新版で動作しなければならない
- **NFR-003**: システムは社外からのアクセスやシステム障害のインシデントをログとして収集しなければならない
- **NFR-004**: システムのエラーメッセージは何が起きたかを明示しなければならない

**システムで実現すること**:

- セキュアな接続を実現するために、バックエンドサーバーとの通信は社内ネットワーク内で完結すること
- (運用上の制約)バックエンドのPlantUMLサーバーは社内ネットワーク内で運用されなければならない
  - アクセス認証・遮断、暗号化はシステム構築で実現するものとする

### 主要エンティティ

- **PlantUMLDocument**: PlantUMLテキストを持つ
- **DiagramImage**: 生成された図の画像データ、形式(PNG/SVG)、サイズを持つ

### 制約

* 外部（社外）PlantUMLサーバーへの接続は禁止 (セキュリティポリシー)
* バックエンドのPlantUMLサーバーは社内ネットワーク内で運用すること

### 測定可能な成果

- **SC-001**: 従来のJava+graphviz+VS Code環境構築がなくなり、ユーザーは1分以内に図の作成を開始できる
- **SC-002**: 編集からプレビュー更新まで`2`秒以内(テキスト更新の検知+画像変換)でレスポンスが返ってくる
- **SC-003**: バックエンドは`100行`のPlantUMLソースを`90パーセンタイル`で`400`ms以内で処理が完了する
- **SC-004**: 90%のユーザーが初回利用時に操作方法を理解し、図を作成できる (直感的なUI)
- **SC-005**: システムは社内ネットワーク内で完全に動作する (セキュリティはシステム層で実現)
- **SC-006**: クロスブラウザ動作テストで100%のテストケースが成功する
- **SC-007**: 一時保存したテキストはブラウザを閉じても保持され、再アクセス時に利用可能である