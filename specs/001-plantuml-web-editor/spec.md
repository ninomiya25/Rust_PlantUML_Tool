# 機能仕様: 社内向けセキュアなPlantUMLウェブエディタ

**Feature Branch**: `001-plantuml-web-editor`  
**作成日**: 2025-12-08  
**Status**: Draft  
**Input**: ユーザーの説明: "全社員(設計者、特に手元に開発環境を用意していないユーザー)を対象にPlantUMLを用いて手軽にUML図を作成できる環境を用意する"

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - PlantUMLテキストからリアルタイム図生成 (優先度: P1)

設計者はブラウザ上でPlantUMLテキストを入力し、即座に図が表示されることで、環境構築なしにUML図を作成できる。

**この優先度の理由**: これが本機能の中核であり、ユーザーが最も必要としている基本的な価値。これだけで実用可能なMVPとなる。

**独立テスト**: ブラウザでエディタを開き、サンプルのPlantUMLテキストを入力して図が表示されることで完全にテストできる。

**受入シナリオ**:

1. **Given** ユーザーがウェブエディタにアクセスした, **When** PlantUMLテキスト (例: `@startuml\nAlice -> Bob: Hello\n@enduml`) を入力する, **Then** 対応するシーケンス図がリアルタイムで表示される
2. **Given** ユーザーが図を表示している, **When** テキストを編集する, **Then** 図が自動的に更新される (1秒以内)
3. **Given** ユーザーが無効なPlantUML構文を入力した, **When** パース処理が実行される, **Then** エラーの位置と原因が明確に表示される

---

### ユーザーストーリー 2 - 図のエクスポート機能 (優先度: P2)

設計者は作成した図を画像ファイル(PNG/SVG)としてダウンロードし、ドキュメントに埋め込むことができる。

**この優先度の理由**: 図を作成しても出力できなければ実用性が低い。ただし、プレビューだけでも価値はあるためP2。

**独立テスト**: PlantUML図を表示後、エクスポートボタンをクリックして画像ファイルがダウンロードされることで検証できる。

**受入シナリオ**:

1. **Given** ユーザーが図を表示している, **When** "PNG形式でエクスポート"ボタンをクリックする, **Then** PNG画像ファイルがダウンロードされる
2. **Given** ユーザーが図を表示している, **When** "SVG形式でエクスポート"ボタンをクリックする, **Then** SVG画像ファイルがダウンロードされる
3. **Given** ユーザーが複雑な図を表示している, **When** エクスポートを実行する, **Then** 高解像度で全要素が含まれた画像が生成される

---

### ユーザーストーリー 3 - ブラウザ上での一時保存・再読込 (優先度: P3)

設計者は作成中のPlantUMLテキストをブラウザ上に一時保存（最大2つ）し、後で再読込ボタンで編集を再開できる。

**この優先度の理由**: 複数の図を比較・切り替えながら作業する際の利便性を高める。ただし、基本機能だけでも価値があるためP3。

**独立テスト**: テキストを入力後、"一時保存"ボタンをクリックし、別のテキストを入力後、"再読込1"ボタンで最初のテキストが復元されることで検証できる。

**受入シナリオ**:

1. **Given** ユーザーがPlantUMLテキストを入力している, **When** "一時保存"ボタンをクリックする, **Then** 現在のテキストがスロット1に保存される
2. **Given** ユーザーが既に1つ保存している, **When** 別のテキストを入力して"一時保存"をクリックする, **Then** 新しいテキストがスロット2に保存される
3. **Given** ユーザーが2つのテキストを保存している, **When** "再読込1"ボタンをクリックする, **Then** スロット1のテキストがエディタに読み込まれる
4. **Given** ユーザーがブラウザを閉じた, **When** 再度エディタにアクセスする, **Then** 保存したテキスト（最大2つ）が保持されている

---

### エッジケース

- **大規模なPlantUMLファイル**: 1000行以上のPlantUMLテキストを入力した場合でもレスポンスが1秒以内か？
- **無効な構文**: 文法エラーのあるPlantUMLを入力した場合、エラーメッセージは具体的か？
- **ブラウザ互換性**: Chrome, Edge, Firefox, Safari で動作するか？
- **バックエンドサーバー障害**: PlantUMLサーバーがダウンしている場合、ユーザーに適切なエラーメッセージが表示されるか？
- **ネットワーク遅延**: ネットワークが遅い環境でも、処理中であることが明確に表示されるか？
- **一時保存の上書き**: 既に2つ保存されている状態で3つ目を保存しようとした場合、適切な警告が表示されるか？
- **複数タブでの一時保存**: 複数タブで同時に一時保存を実行した場合の挙動は？
- **同時編集**: 複数タブで同じエディタを開いた場合の挙動は？
- **セッションの永続性**: ブラウザをリフレッシュしても編集中のテキストは保持されるか？
- **LocalStorageの容量制限**: 大きなPlantUMLテキストを保存した場合、LocalStorageの制限に達しないか？

## 画面遷移/フロー

本システムはシングルページアプリケーション (SPA) として構成され、画面遷移は発生しない。

**ホーム画面（メイン画面）のみ**:
- 左側: PlantUMLテキストエディタ
- 右側: 生成された図のプレビューエリア
- 上部: エクスポートボタン（PNG/SVG）、一時保存ボタン
- 下部: 再読込ボタン（再読込1、再読込2）

すべての機能は単一の画面内で完結し、ページリロードや画面遷移は不要。

## 入出力仕様

### 対応ファイル形式

PlantUMLサーバーが変換に対応している入力ファイル拡張子:
- テキスト形式: `.txt`, `.md`
- マークアップ形式: `.tex`, `.htm`, `.html`, `.apt`
- プログラミング言語: `.java`, `.c`, `.h`, `.cpp`, `.hpp`, `.hh`
- PlantUML専用: `.pu`, `.puml`

**注**: 本システムではブラウザ上でのテキスト入力のみをサポートし、ファイルアップロード機能は提供しない（コピー&ペーストで対応）。

### 出力形式

- **PNG形式**: ラスター画像、ドキュメント埋め込みに適する
- **SVG形式**: ベクター画像、拡大縮小しても品質が劣化しない

### PlantUMLサーバー実行例

バックエンドでのPlantUML実行コマンド例:
```bash
java -jar plantuml-1.2025.10.jar ./sequenceDiagram.txt
```

または、PlantUMLサーバーAPIを使用:
```bash
# テキストをサーバーに送信してPNG画像を取得
curl -X POST http://internal-plantuml-server/png \
  -H "Content-Type: text/plain" \
  -d "@startuml\nAlice -> Bob: Hello\n@enduml"
```

### データフロー

1. **入力**: ユーザーがブラウザ上でPlantUMLテキストを入力
2. **送信**: フロントエンドがバックエンドAPIにテキストを送信
3. **処理**: バックエンドのPlantUMLサーバーが図を生成
4. **出力**: PNG/SVG形式の画像データをフロントエンドに返却
5. **表示**: ブラウザ上でプレビュー表示

## インターフェース/データ契約

### 入力データ仕様

**形式**: テキストデータ (UTF-8エンコーディング)

**必須要件**:
- ✅ テキスト形式であること
- ✅ `null` または空白文字のみでないこと
- ✅ `@startuml` タグで開始すること（図の開始を示す）
- ✅ `@enduml` タグで終了すること（図の終了を示す）

**バリデーションルール**:
```
有効な入力例:
@startuml
Alice -> Bob: Hello
@enduml

無効な入力例:
- 空文字列 → エラー: "入力が空です"
- タグなし → 警告: "画像が生成されません。@startuml と @enduml タグが必要です"
- @startuml のみ → エラー: "@enduml タグが見つかりません"
```

### 出力データ仕様

**正常時の出力**: PNG形式のバイナリデータ

**必須要件**:
- ✅ PNG形式のバイナリデータであること
- ✅ 画像データが空でないこと（画像サイズ > 0バイト）
- ✅ 有効なPNGヘッダーを持つこと（`89 50 4E 47`で始まる）

**エラー時の出力**:

1. **PlantUML構文エラー**:
   - PlantUMLが検出したエラー内容をPNG画像として返す
   - エラー画像には以下が含まれる:
     - エラーメッセージ
     - エラーが発生した行番号
     - 問題のある構文の詳細
   - HTTPステータス: `200 OK`（エラー内容を画像で返すため）

2. **システムエラー**:
   - バックエンドサーバーの障害
   - PlantUMLサーバープロセスのクラッシュ
   - HTTPステータス: `500 Internal Server Error`
   - レスポンスボディ: JSON形式のエラーメッセージ
   ```json
   {
     "error": "システムエラーが発生しました",
     "detail": "PlantUMLサーバーに接続できません",
     "solution": "しばらく待ってから再試行してください。問題が続く場合は管理者に連絡してください"
   }
   ```

3. **ネットワークエラー**:
   - タイムアウト（30秒以上応答なし）
   - 接続エラー
   - HTTPステータス: `504 Gateway Timeout` または `503 Service Unavailable`
   - レスポンスボディ: JSON形式のエラーメッセージ
   ```json
   {
     "error": "ネットワークエラーが発生しました",
     "detail": "サーバーへの接続がタイムアウトしました",
     "solution": "ネットワーク接続を確認して再試行してください"
   }
   ```

### API契約（バックエンド）

**エンドポイント**: `POST /api/v1/convert`

**リクエスト**:
```http
POST /api/v1/convert HTTP/1.1
Content-Type: application/json

{
  "source": "@startuml\nAlice -> Bob: Hello\n@enduml",
  "format": "png"  // "png" or "svg"
}
```

**レスポンス（成功）**:
```http
HTTP/1.1 200 OK
Content-Type: image/png
Content-Length: [画像サイズ]

[PNG画像のバイナリデータ]
```

**レスポンス（PlantUML構文エラー）**:
```http
HTTP/1.1 200 OK
Content-Type: image/png
Content-Length: [エラー画像サイズ]

[エラー内容を含むPNG画像のバイナリデータ]
```

**レスポンス（システムエラー）**:
```http
HTTP/1.1 500 Internal Server Error
Content-Type: application/json

{
  "error": "システムエラーが発生しました",
  "detail": "PlantUMLサーバーに接続できません",
  "solution": "しばらく待ってから再試行してください"
}
```


## 要件 *(必須)*

### 機能要件

- **FR-001**: システムはブラウザ上でPlantUMLテキストを編集できるテキストエディタを提供しなければならない
- **FR-002**: システムは入力されたPlantUMLテキストをバックエンドのPlantUMLサーバーに送信し、UML図を生成しなければならない
- **FR-003**: システムは図の生成を1秒以内に完了し、リアルタイムプレビューを提供しなければならない
- **FR-004**: システムはPlantUML構文エラーを検出し、エラーの行番号と原因を表示しなければならない
- **FR-005**: システムは生成された図をPNG形式でエクスポートする機能を提供しなければならない
- **FR-006**: システムは生成された図をSVG形式でエクスポートする機能を提供しなければならない
- **FR-007**: システムはPlantUMLテキストを最大2つまでブラウザのローカルストレージに一時保存する機能を提供しなければならない
- **FR-008**: システムは一時保存したPlantUMLテキストを再読込する機能（再読込1、再読込2）を提供しなければならない
- **FR-009**: システムはバックエンドでPlantUMLサーバーを運用し、テキストから画像への変換処理を実行しなければならない
- **FR-010**: システムはブラウザをリフレッシュしても一時保存したテキスト（最大2つ）を保持しなければならない(検討)

### 非機能要件

- **NFR-001**: バックエンドのPlantUMLサーバーは1000行のPlantUMLファイルを100ms以内で処理しなければならない (Constitution パフォーマンス要件準拠)
- **NFR-002**: バックエンドのメモリ使用量は入力ファイルサイズの3倍以内に抑えなければならない (Constitution 準拠)
- **NFR-003**: フロントエンドはChrome、Edge、Firefox、Safariの最新版で動作しなければならない
- **NFR-004**: バックエンドのPlantUMLサーバーは社内ネットワーク内で運用され、外部からアクセスできてはならない (セキュリティ要件)
- **NFR-005**: システムのエラーメッセージは「何が起きたか」「なぜ起きたか」「どう解決するか」を含めなければならない (Constitution UX要件準拠)
- **NFR-006**: バックエンドサーバーとの通信は社内ネットワーク内で完結し、セキュアな接続を使用しなければならない

### 主要エンティティ

- **PlantUMLDocument**: PlantUMLテキスト、作成日時、最終更新日時を持つ
- **DiagramImage**: 生成された図の画像データ、形式(PNG/SVG)、サイズを持つ
- **ParseError**: エラーメッセージ、行番号、列番号、エラー種別を持つ
- **SavedSlot**: スロット番号（1または2）、保存されたPlantUMLテキストを持つ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは環境構築なしに1分以内にPlantUML図の作成を開始できる
- **SC-002**: 編集からプレビュー更新まで1秒以内でレスポンスが返る
- **SC-003**: バックエンドは1000行のPlantUMLファイルでも100ms以内で処理が完了する (Constitution パフォーマンス基準)
- **SC-004**: 90%のユーザーが初回利用時に操作方法を理解し、図を作成できる (直感的なUI)
- **SC-005**: システムは社内ネットワーク内で完全に動作し、外部への通信は発生しない (セキュリティ要件達成)
- **SC-006**: クロスブラウザ動作テストで100%のテストケースが成功する
- **SC-007**: 従来のJava+VS Code環境構築にかかっていた時間(平均30分)がゼロになる
- **SC-008**: 一時保存したテキストはブラウザを閉じても保持され、再アクセス時に利用可能である(検討)

## 前提と制約

### 前提

- ユーザーは社内ネットワークからアクセスする
- ユーザーはモダンブラウザ (Chrome/Edge/Firefox/Safari最新版) を使用している
- PlantUMLの基本的な構文知識をユーザーが持っている、またはドキュメントを参照できる

### 制約

- 外部（社外）PlantUMLサーバーへの接続は禁止 (セキュリティポリシー)
- バックエンドのPlantUMLサーバーは社内ネットワーク内で運用すること
- ユーザー認証は本フェーズでは不要 (将来拡張で検討)
- ファイルのアップロード・ダウンロード機能は実装しない（コピー&ペーストで代替可能）
- オフライン動作は対応しない（社内ネットワーク接続を前提）
